$(function() {
	
	// show welcome modal before starting signup process
	if (gon.getting_started_step == 0) {
		$(window).load(function(){
	        $('#complete_signup_welcome').modal('show');
	    });
	}
	
	// use Modernizr to add datepicker view to browsers that don't support date
	if (!Modernizr.inputtypes.date) {
	  $("input[type='date']").datepicker();
	}

	// set up use of tooltip within a link
	$('[data-tooltip="tooltip"]').tooltip();
	
	// set default for unsaved form monitoring
	var unsaved = false;
	
	// hide spinner
	$(".spinner-signup").hide();
	
	// show spinner on AJAX start
	$(document).ajaxStart(function(){
	  $(".spinner-signup").show(0);
	});
	
	// hide spinner on AJAX stop
	$(document).ajaxStop(function(){
	  $(".spinner-signup").delay(500).hide(0);
	});
  
  	// set height of style tiles in likes/dislikes views to equal width
	style_tile_width = $(".signup-style-tile").width();
	$(".signup-style-tile").height(style_tile_width);
	$(".signup-style-tile.chosen").height(style_tile_width);
	$(".signup-styles-tally-box").height(style_tile_width);
	
	
	// set height of mobile user signup filler column
	first_col_height = $("#mobile-user-signup-first-col").height();
	$(".mobile-user-signup-filler-col").height(first_col_height);
	
	$( window ).on( "orientationchange", function( event ) {
		style_tile_width = $(".signup-style-tile").width();
		$(".signup-style-tile").height(style_tile_width);
		$(".signup-style-tile.chosen").height(style_tile_width);
		$(".signup-style-tile.chosen").width(style_tile_width);
		$(".signup-styles-tally-box").height(style_tile_width);
	});
	
	// set height of membership feature list div
	feature_list_height_12_mo = $("#retail-plan-feature-list-12-mo").height();
	$(".retail-plan-feature-list").height(feature_list_height_12_mo);
	
  // set delay function
	var delay = (function(){
	  var timer = 0;
	  return function(callback, ms){
	    clearTimeout (timer);
	    timer = setTimeout(callback, ms);
	  };
	})();
	
	// search for username to see if unique
	$(document).on("keyup", "#username_field", function() {
		if ($(".user_username").hasClass('has-error')) {
			$(".user_username").removeClass('has-error');
			$(".user_username").children('span').remove();
		}
		if ($("#username-not-available").hasClass('show')) {
			$("#username-not-available").removeClass('show').addClass('hidden');
		}
		if ($("#username-available").hasClass('show')) {
			$("#username-available").removeClass('show').addClass('hidden');
		}
		
		delay(function(){
			value = $('#username_field').val();
			$.ajax({
			  type: "POST",
			  url: "/signup/username_verification/" + value
			});
	    }, 2000 );
	});
	
	// remove email signup error message upon focus
	$(document).on("focus", "#email_field", function() {
		if ($('.user_email').hasClass('has-error')) {
			$('.user_email').removeClass('has-error');
			$('.user_email').children('span').remove();
		}
	});
	
	// search for discount code to see if valid
	$(document).on("click", ".code-verification-next-button", function() {
		value = $('#special_code').val();
		delay(function(){
			$.ajax({
			  type: "POST",
			  url: "/early_signup/process_invitation_code/" + value
			});
	    }, 500 );
	});
	
	// clear invalid response 
	$(document).on("keyup", "#special_code", function() {
		if ($("#invalid_code").hasClass('show')) {
			$("#invalid_code").removeClass('show').addClass('hidden');
		}
	});
	
	// show extra thoughts for mobile 
	$(document).on("click", "#mobile-extra-thoughts-link", function() {
		$(this).removeClass("show").addClass("hidden");
		$('#mobile-extra-thoughts-link-to-hide').removeClass("hidden").addClass("show");
		$('#mobile-delivery-thoughts-container').removeClass("hidden").addClass("show");
	});
	
	// hide extra thoughts for mobile
	$(document).on("click", "#mobile-extra-thoughts-link-to-hide", function() {
		$(this).removeClass("show").addClass("hidden");
		$('#mobile-extra-thoughts-link').removeClass("hidden").addClass("show");
		$('#mobile-delivery-thoughts-container').removeClass("show").addClass("hidden");
	});
	
	// change unsaved back to true if save button is clicked
	$(document).on('click', '#update_delivery_preferences_button', function () {
	    unsaved = false;
	});
	// bind event to page navigation
	$(window).bind('beforeunload', function() {
	    if(unsaved){
	        return "You have unsaved changes on this page. Do you want to leave this page and discard your changes or stay on this page?";
	    }
	});
	
	// find width of tile so overlay matches
	var like_tile_width = $('.signup-style-tile.like-style-tile').width();
	$('.signup-style-tile.like-style-tile.chosen').width(like_tile_width);
	var dislike_tile_width = $('.signup-style-tile.dislike-style-tile').width();
	$('.signup-style-tile.dislike-style-tile.chosen').width(dislike_tile_width);
	
	// add logic to change background color of image chosen and send data to controller
	$(document).on('click', '.signup-category-image-holder', function () {
		$(this).siblings('.signup-category-image-holder-chosen-cover').removeClass('hidden').addClass('show');
		$(this).parent().siblings('.signup-category-image-holder-parent').children('.signup-category-image-holder-chosen-cover').removeClass('show').addClass('hidden');
		
		var id_info = $(this).attr('id');
		var id_split = id_info.split('-');
		var choice = id_split[0];
		var current_page = id_split[1];
		
		if (choice == "beer") {
			var new_value = 1
		} else if (choice == "cider") {
			var new_value = 2
		} else {
			var new_value = 3
		}
		
		if(current_page == "signup") {
			// send data to controller
			$.ajax({
			  type: "POST",
			  url: "/signup/process_drink_choice_getting_started/" + new_value
			});
			
			$('#drink_choice_next_step_button').removeAttr('disabled');
			$("#drink_choice_next_step_button").removeClass('btn-default').addClass('btn-success');
		} else {
			$('#delivery_preference_drink_option_id').val(new_value);
			$('#update_delivery_preferences_button').removeAttr('disabled');
			$('#update_delivery_preferences_button').removeClass('btn-default').addClass('btn-success');
			// indicate there is unsave data changed on the page
			unsaved = true;
		}
		
	});
	
	$(document).on('click', '.signup-journey-image-holder', function () {
		$(this).siblings('.signup-journey-image-holder-chosen-cover').removeClass('hidden').addClass('show');
		$(this).parent().siblings('.signup-journey-image-holder-parent').children('.signup-journey-image-holder-chosen-cover').removeClass('show').addClass('hidden');
		
		var id_info = $(this).attr('id');
		var id_split = id_info.split('-');
		var choice = id_split[0];
		var current_page = id_split[1];
		
		if (choice == "casual") {
			var new_value = 1
		} else if (choice == "geek") {
			var new_value = 2
		} else {
			var new_value = 3
		}
		
		if(current_page == "signup") {
			var controller_url = "/signup/process_drink_journey_getting_started/" + new_value
			
			$('#drink_journey_next_step_button').removeAttr('disabled');
			$("#drink_journey_next_step_button").removeClass('btn-default').addClass('btn-success');
		} else {
			var controller_url = "/delivery_settings/deliveries_update_estimates/craft_journey-" + new_value
		}
		
		// send data to controller
		$.ajax({
		  type: "POST",
		  url: controller_url
		});
	});
	
	$(document).on('click', '#delivery_preference_gluten_free', function () {
		
		var new_value = $(this).val();
		
		// send data to controller
		$.ajax({
		  type: "POST",
		  url: "/signup/process_drink_style_likes_getting_started/" + new_value
		});
	});
	
	// add logic to change background color of number boxes and send data to controller
	$(document).on('click', '.number-box-holder.weekly-drinks', function () {
		$(this).addClass('chosen');
		$(this).parent().siblings('.number-box-holder-parent').children('.number-box-holder').removeClass('chosen');
		
		var id_info = $(this).attr('id');
		var id_split = id_info.split('-');
		var drinks_per_week = id_split[0];
		var current_page = id_split[1];

		var large_format_original = $(".number-box-holder.large-format.chosen").attr('id');
		if(large_format_original != undefined) {
			var split_original = large_format_original.split('-');
			var large_format = split_original[0];
			
			if(large_format > drinks_per_week){
				large_format = drinks_per_week;
				$("#delivery_preference_max_large_format").val(large_format);
			}
		}
		
		if(current_page == "signup") {
			var controller_url = "/signup/process_drinks_weekly_getting_started/" + drinks_per_week
			if($("#drinks-per-week-meaning-row").hasClass("hidden")) {
				$("#drinks-per-week-meaning-row").removeClass("hidden").addClass("show");
			}
		} else {
			$("#delivery_preference_drinks_per_week").val(drinks_per_week);
			$('#update_delivery_preferences_button').removeAttr('disabled');
			$('#update_delivery_preferences_button').removeClass('btn-default').addClass('btn-success');
			var controller_url = "/delivery_settings/deliveries_update_estimates/drinks_per_week-" + drinks_per_week + "-" + large_format
			// indicate there is unsave data changed on the page
			unsaved = true;
		}
		 
		// send data to controller
		$.ajax({
		  type: "POST",
		  url: controller_url
		});
		
	});
	
	$(document).on('click', '.signup-plan-start-holder', function () {
		$(this).siblings('.signup-plan-start-holder-chosen-cover').removeClass('hidden').addClass('show');
		$(this).parent().siblings('.signup-plan-start-holder-parent').children('.signup-plan-start-holder-chosen-cover').removeClass('show').addClass('hidden');
		
		var id_info = $(this).attr('id');
		var id_split = id_info.split('-');
		var start_choice = id_split[0];
		var current_page = id_split[1];
		
		if(current_page == "signup") {
			// send data to controller
			$.ajax({
			  type: "POST",
			  url: "/signup/process_input/account-2-" + start_choice
			});
		} else {
			$('#delivery_preference_first_delivery_date').val(new_value);
			$('#update_delivery_preferences_button').removeAttr('disabled');
			$('#update_delivery_preferences_button').removeClass('btn-default').addClass('btn-success');
			// indicate there is unsave data changed on the page
			unsaved = true;
		}
		
	});
	
	// add logic to change background color of number boxes and send data to controller
	$(document).on('click', '.number-box-holder.large-format', function () {
		$(this).addClass('chosen');
		$(this).parent().siblings('.number-box-holder-parent').children('.number-box-holder').removeClass('chosen');
		
		var id_info = $(this).attr('id');
		var id_split = id_info.split('-');
		var large_format = id_split[0];
		var current_page = id_split[1];
		
		var drinks_per_week_original = $(".number-box-holder.weekly-drinks.chosen").attr('id');
		if(drinks_per_week_original != undefined) {
			var split_original = drinks_per_week_original.split('-');
			var drinks_per_week = split_original[0];
		}
		
		if(current_page == "signup") {
			var controller_url = "/signup/process_drinks_large_getting_started/" + large_format
		} else {
			$("#delivery_preference_max_large_format").val(large_format);
			$('#update_delivery_preferences_button').removeAttr('disabled');
			$('#update_delivery_preferences_button').removeClass('btn-default').addClass('btn-success');
			var controller_url = "/delivery_settings/deliveries_update_estimates/large_format-" + drinks_per_week + "-" + large_format
			// indicate there is unsave data changed on the page
			unsaved = true;
		}
		
		// send data to controller
		$.ajax({
		  type: "POST",
		  url: controller_url
		});
		
	});
	
	// send additional delivery preferences to controller
	$(document).on("keyup", "#delivery_preference_additional", function() {
		$('#update_delivery_preferences_button').removeAttr('disabled');
		$('#update_delivery_preferences_button').removeClass('btn-default').addClass('btn-success');
		// indicate there is unsave data changed on the page
		unsaved = true;
	});
	
	// keep track of how many styles have been chosen
	var styles_liked = gon.number_of_liked_styles;
	var styles_disliked = gon.number_of_disliked_styles;
	
	// add logic to change background color of style chosen and send data to controller
	$(document).on('click', '.signup-style-tile.like-style-tile', function () {
		if($(this).siblings('.signup-style-tile.like-style-tile.chosen').hasClass('hidden')) {
			if(styles_liked <= 5) {
				styles_liked = styles_liked + 1;
			}
			if(styles_liked == 1) {
				$("#liked_styles_next_step_button").removeAttr('disabled');
				$("#liked_styles_next_step_button").addClass('btn-success');
			}
			if(styles_liked <= 5) {
				// display number of liked styles
				$("#number_of_liked_styles").html(styles_liked);
				// find width of tile so overlay matches
				var original_tile_width = $(this).width();
				$(this).siblings('.signup-style-tile.like-style-tile.chosen').width(original_tile_width);
				$(this).siblings('.signup-style-tile.like-style-tile.chosen').removeClass('hidden').addClass('show');
				
				var style_id = $(this).attr('id');
				
				// send data to controller
				$.ajax({
				  type: "POST",
				  url: "/signup/process_style_input/like-add-" + style_id
				});
			} else {
				styles_liked = styles_liked - 1;
				
				$("#max_likes").modal("show");
			}
		} else {
			styles_liked = styles_liked - 1;
			// display number of liked styles
			$("#number_of_liked_styles").html(styles_liked);
			
			$(this).removeClass('show').addClass('hidden');
			
			var style_id = $(this).attr('id');
			
			// send data to controller
			$.ajax({
			  type: "POST",
			  url: "/signup/process_style_input/like-remove-" + style_id
			});
			
			// remove button functionality if fewer than one like
			if(styles_liked < 1) {
				$("#liked_styles_next_step_button").attr('disabled', 'disabled');
				$("#liked_styles_next_step_button").removeClass('btn-success');
			}
		}
	});
	
	$(document).on('click', '.signup-style-tile.dislike-style-tile', function () {
		if($(this).siblings('.signup-style-tile.dislike-style-tile.chosen').hasClass('hidden')) {
			if(styles_disliked <= 5) {
				styles_disliked = styles_disliked + 1;
			}
			if(styles_disliked <= 5) {
				// display number of liked styles
				$("#number_of_disliked_styles").html(styles_disliked);
				// find width of tile so overlay matches
				var original_tile_width = $(this).width();
				$(this).siblings('.signup-style-tile.dislike-style-tile.chosen').width(original_tile_width);
				$(this).siblings('.signup-style-tile.dislike-style-tile.chosen').removeClass('hidden').addClass('show');
				
				var style_id = $(this).attr('id');
				
				// send data to controller
				$.ajax({
				  type: "POST",
				  url: "/signup/process_style_input/dislike-add-" + style_id
				});
			} else {
				styles_disliked = styles_disliked - 1;
				alert("You can only choose 5!");
			}
		} else {
			styles_disliked = styles_disliked - 1;
			// display number of disliked styles
			$("#number_of_disliked_styles").html(styles_disliked);
			
			$(this).removeClass('show').addClass('hidden');
			
			var style_id = $(this).attr('id');
			
			// send data to controller
			$.ajax({
			  type: "POST",
			  url: "/signup/process_style_input/dislike-remove-" + style_id
			});

		}
	});
});